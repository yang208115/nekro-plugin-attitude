<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>态度管理系统 - 后台控制面板</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary-color: #4361ee; --primary-hover: #3a56d4; --secondary-color: #3f37c9;
            --success-color: #4cc9f0; --danger-color: #f72585; --warning-color: #f8961e;
            --info-color: #4895ef; --light-color: #f8f9fa; --dark-color: #212529; --gray-color: #6c757d;
            --border-radius: 8px; --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a1929; background-image: linear-gradient(to bottom, #0a1929, #0d2340);
            color: #e0e0e0; line-height: 1.6; margin: 0; padding: 0; overflow-x: hidden; position: relative;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(circle at 10% 20%, rgba(76, 201, 240, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 30%, rgba(67, 97, 238, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 30% 70%, rgba(247, 37, 133, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 70% 80%, rgba(76, 201, 240, 0.03) 0%, transparent 20%);
            pointer-events: none; z-index: -1;
        }
        .dashboard { display: flex; flex-direction: column; min-height: 100vh; width: 100%; padding: 20px; box-sizing: border-box; }
        .main-content { width: 100%; padding: 0; margin: 0 auto; max-width: 100%; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .header h1 { font-size: 1.8rem; color: #e0e0e0; font-weight: 600; }
        .card {
            background: rgba(20, 30, 50, 0.7); border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); padding: 25px; margin-bottom: 25px;
            transition: var(--transition); border: 1px solid rgba(76, 201, 240, 0.3);
            position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        .card:hover {
            box-shadow: 0 6px 25px rgba(76, 201, 240, 0.2);
            border: 1px solid rgba(76, 201, 240, 0.5); transform: translateY(-2px);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .card-header h2 {
            font-size: 1.4rem; color: #e0e0e0; font-weight: 600; display: flex; align-items: center;
        }
        .card-header h2 i { margin-right: 10px; color: var(--primary-color); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #e0e0e0; }
        .form-control {
            width: 100%; padding: 12px 15px; border: 1px solid rgba(76, 201, 240, 0.3);
            border-radius: var(--border-radius); font-size: 1rem; transition: var(--transition);
            background-color: rgba(20, 30, 50, 0.5); color: #e0e0e0;
        }
        .form-control:focus {
            border-color: var(--primary-color); outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); background-color: rgba(30, 40, 60, 0.7);
        }
        .form-control::placeholder { color: rgba(224, 224, 224, 0.5); }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px;
            border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 500;
            cursor: pointer; transition: var(--transition); text-decoration: none; margin-right: 10px;
        }
        .btn i { margin-right: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #3ab7db; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #e01e79; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-warning:hover { background-color: #e58613; }
        
        .response-container { margin-top: 20px; border-radius: var(--border-radius); overflow: hidden; }
        
        .response-header { padding: 12px 15px; background-color: rgba(30, 40, 60, 0.9); border: 1px solid rgba(76, 201, 240, 0.3); border-bottom: none; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; }
        
        .response-header h3 { font-size: 1rem; margin: 0; color: #e0e0e0; }
        
        .response { padding: 15px; border: 1px solid rgba(76, 201, 240, 0.3); border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto; background-color: rgba(20, 30, 50, 0.7); color: #e0e0e0; }
        
        .success { border-color: rgba(76, 201, 240, 0.5); }
        .success .response-header { background-color: rgba(76, 201, 240, 0.2); border-color: rgba(76, 201, 240, 0.5); color: #e0e0e0; }
        .success .response-header h3 { color: #4cc9f0; }
        
        .error { border-color: rgba(247, 37, 133, 0.5); }
        .error .response-header { background-color: rgba(247, 37, 133, 0.2); border-color: rgba(247, 37, 133, 0.5); color: #e0e0e0; }
        .error .response-header h3 { color: #f72585; }
        
        .info { border-color: rgba(67, 97, 238, 0.5); }
        .info .response-header { background-color: rgba(67, 97, 238, 0.2); border-color: rgba(67, 97, 238, 0.5); color: #e0e0e0; }
        .info .response-header h3 { color: #4361ee; }
        
        .url-display { background-color: rgba(20, 30, 50, 0.7); padding: 12px 15px; border-radius: var(--border-radius); font-family: 'Courier New', monospace; margin-bottom: 15px; word-break: break-all; border: 1px solid rgba(76, 201, 240, 0.3); color: #e0e0e0; font-size: 0.9rem; }
        
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        
        .stat-card { background: rgba(20, 30, 50, 0.7); border-radius: var(--border-radius); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); padding: 20px; display: flex; align-items: center; border: 1px solid rgba(76, 201, 240, 0.3); position: relative; overflow: hidden; }
        
        .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); }
        
        /* 数据表格样式 */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: rgba(20, 30, 50, 0.7); border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); border: 1px solid rgba(76, 201, 240, 0.3); }
        
        thead { background-color: rgba(30, 40, 60, 0.9); }
        th { padding: 15px; text-align: left; color: #e0e0e0; font-weight: 600; border-bottom: 2px solid rgba(76, 201, 240, 0.5); position: relative; }
        th:hover { background-color: rgba(40, 50, 70, 0.9); cursor: pointer; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(76, 201, 240, 0.2); color: #e0e0e0; vertical-align: middle; }
        tr:hover { background-color: rgba(30, 40, 60, 0.8); }
        
        /* 分页控件样式 */
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; margin-bottom: 20px; background-color: rgba(20, 30, 50, 0.7); border-radius: var(--border-radius); padding: 10px 15px; border: 1px solid rgba(76, 201, 240, 0.3); }
        
        .pagination-info { color: #e0e0e0; font-size: 0.9rem; }
        .pagination-buttons { display: flex; gap: 10px; }
        .pagination-buttons button { background-color: rgba(30, 40, 60, 0.9); color: #e0e0e0; border: 1px solid rgba(76, 201, 240, 0.3); border-radius: var(--border-radius); padding: 5px 15px; cursor: pointer; transition: var(--transition); }
        .pagination-buttons button:hover { background-color: rgba(40, 50, 70, 0.9); border-color: var(--primary-color); }
        .pagination-buttons button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* 搜索框和过滤器样式 */
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .search-container { position: relative; flex: 1; min-width: 250px; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(224, 224, 224, 0.5); }
        
        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid rgba(76, 201, 240, 0.3);
            border-radius: var(--border-radius);
            background-color: rgba(20, 30, 50, 0.7);
            color: #e0e0e0;
            transition: var(--transition);
        }
        
        .search-input:focus {
            border-color: var(--primary-color);
            outline: none;
            background-color: rgba(30, 40, 60, 0.7);
        }
        
        .search-input::placeholder {
            color: rgba(224, 224, 224, 0.5);
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 1px solid rgba(76, 201, 240, 0.3);
            border-radius: var(--border-radius);
            background-color: rgba(20, 30, 50, 0.7);
            color: #e0e0e0;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .filter-select:focus {
            border-color: var(--primary-color);
            outline: none;
            background-color: rgba(30, 40, 60, 0.7);
        }
        
        .filter-select option {
            background-color: rgba(20, 30, 50, 0.9);
            color: #e0e0e0;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.8rem;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        
        .stat-users {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }
        
        .stat-groups { background-color: rgba(76, 201, 240, 0.1); color: var(--success-color); }
        
        .stat-positive { background-color: rgba(72, 149, 239, 0.1); color: var(--info-color); }
        
        .stat-negative { background-color: rgba(247, 37, 133, 0.1); color: var(--danger-color); }
        
        .stat-info h3 { font-size: 1.8rem; font-weight: 600; margin-bottom: 5px; }
        
        .stat-info p { color: var(--gray-color); font-size: 0.9rem; margin: 0; }
        
        @media (max-width: 992px) {
            .dashboard { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .main-content { grid-column: 1; padding: 15px; }
            .stats-container { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        }
        
        @media (max-width: 768px) {
            .stats-container { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 576px) {
            .stats-container { grid-template-columns: 1fr; }
            .card { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- 主内容区 -->
        <div class="main-content">
            <div class="header" style="justify-content: center;">
            <h1 style="margin: 0 auto;">态度插件后台管理系统</h1>
            <div style="position: absolute; right: 20px; display: flex; align-items: center; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="ip-input" style="color: #e0e0e0; font-size: 0.9rem; white-space: nowrap;">服务器IP:</label>
                    <input type="text" id="ip-input" class="form-control" style="width: 150px; padding: 8px 12px; font-size: 0.9rem;" placeholder="IP地址" value="0.0.0.0" onchange="updateBaseUrl()">
                </div>
                <button class="btn btn-primary" onclick="getAllUsers(); getAllGroups();"><i class="bi bi-arrow-clockwise"></i> 刷新数据</button>
                <button id="batch-test-btn" class="btn btn-info" onclick="runAllTests()" style="display: none;"><i class="bi bi-play"></i> 批量测试</button>
            </div>
        </div>
            
            <!-- 统计卡片 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon stat-users">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="user-count">0</h3>
                        <p>用户总数</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-groups">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="group-count">0</h3>
                        <p>群组总数</p>
                    </div>
                </div>
            </div>
            
            <!-- 批量测试响应容器 -->
            <div id="batch-response-container" class="response-container" style="display: none;">
                <div class="response-header">
                    <h3>批量测试结果</h3>
                    <button class="btn btn-sm btn-danger" onclick="document.getElementById('batch-response-container').style.display='none';"><i class="bi bi-x"></i></button>
                </div>
                <pre id="batch-response" class="response"></pre>
            </div>
            
            <div style="display: flex; gap: 20px; margin-bottom: 25px;">
                
                <!-- 用户态度管理 -->
                <div class="card" id="users-section" style="flex: 1;">
                <div class="card-header">
                    <h2><i class="bi bi-person"></i> 用户态度管理</h2>
                    <button class="btn btn-success" onclick="getAllUsers()"><i class="bi bi-list"></i> 获取所有用户</button>
                </div>
                
                <!-- 获取所有用户态度 -->
                <div class="form-group">
                    <div class="url-display">GET /plugins/yang208115.nekro_plugin_attitude/users</div>
                    
                    <!-- 搜索和筛选 -->
                    <div class="search-filter-container" style="margin-bottom: 15px;">
                        <div class="row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <input type="text" class="form-control" id="user-search" placeholder="搜索QQ号" onkeyup="filterUserTable()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 用户表格视图 -->
                    <div class="table-container" style="margin-bottom: 20px; display: none;" id="users-table-container">
                        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3>用户列表</h3>
                            <div>
                                <button class="btn btn-sm btn-info" onclick="exportUserData()"><i class="bi bi-download"></i> 导出数据</button>
                                <select class="form-control" id="users-per-page" style="display: inline-block; width: auto; margin-left: 10px;" onchange="changeUsersPerPage()">
                                    <option value="10">10条/页</option>
                                    <option value="20">20条/页</option>
                                    <option value="50">50条/页</option>
                                    <option value="100">100条/页</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="users-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortUserTable(0)">QQ号 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortUserTable(1)">用户名称 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortUserTable(2)">态度值 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortUserTable(3)">关系 <i class="bi bi-arrow-down-up"></i></th>
                                        <th>其他信息</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- 用户数据将通过JavaScript动态填充 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <div class="pagination-info">显示 <span id="users-showing-start">0</span>-<span id="users-showing-end">0</span> 条，共 <span id="users-total-count">0</span> 条</div>
                            <div class="pagination-controls">
                                <button class="btn btn-sm btn-primary" id="users-prev-page" onclick="prevUsersPage()"><i class="bi bi-chevron-left"></i> 上一页</button>
                                <span class="pagination-pages" id="users-pagination-pages">第 <span id="users-current-page">1</span>/<span id="users-total-pages">1</span> 页</span>
                                <button class="btn btn-sm btn-primary" id="users-next-page" onclick="nextUsersPage()">下一页 <i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="response-container" id="users-response-container" style="display:none;">
                        <div class="response-header">
                            <h3>响应结果</h3>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('users-response-container').style.display='none';"><i class="bi bi-x"></i></button>
                        </div>
                        <div id="users-response" class="response"></div>
                    </div>
                </div>
                
                <!-- 更新用户态度 -->
                <div class="form-group">
                    <h3>更新用户态度</h3>
                    <div class="url-display">PUT /plugins/yang208115.nekro_plugin_attitude/users/{user_id}</div>
                    
                    <div class="form-group">
                        <label class="form-label" for="user-id">QQ号:</label>
                        <input type="text" class="form-control" id="user-id" placeholder="例如: 123456789">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="user-attitude">态度值:</label>
                        <input type="text" class="form-control" id="user-attitude" value="" placeholder="输入态度值 (支持数字或文字)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="user-relationship">用户关系:</label>
                        <input type="text" class="form-control" id="user-relationship" placeholder="输入关系（如：friend, enemy, neutral）">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="user-other">用户其他信息:</label>
                        <textarea class="form-control" id="user-other" rows="3" placeholder="输入其他信息"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="updateUser()"><i class="bi bi-save"></i> 更新用户态度</button>
                    
                    <div class="response-container" id="user-update-response-container" style="display:none;">
                        <div class="response-header">
                            <h3>响应结果</h3>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('user-update-response-container').style.display='none';"><i class="bi bi-x"></i></button>
                        </div>
                        <div id="user-update-response" class="response"></div>
                    </div>
                </div>
            </div>
            
            <!-- 群组态度管理 -->
            <div class="card" id="groups-section">
                <div class="card-header">
                    <h2><i class="bi bi-people"></i> 群组态度管理</h2>
                    <button class="btn btn-success" onclick="getAllGroups()"><i class="bi bi-list"></i> 获取所有群组</button>
                </div>
                
                <!-- 获取所有群组态度 -->
                <div class="form-group">
                    <div class="url-display">GET /plugins/yang208115.nekro_plugin_attitude/groups</div>
                    
                    <!-- 搜索和筛选 -->
                    <div class="search-filter-container" style="margin-bottom: 15px;">
                        <div class="row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <input type="text" class="form-control" id="group-search" placeholder="搜索群号或群组名称..." onkeyup="filterGroupTable()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 群组表格视图 -->
                    <div class="table-container" style="margin-bottom: 20px; display: none;" id="groups-table-container">
                        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3>群组列表</h3>
                            <div>
                                <button class="btn btn-sm btn-info" onclick="exportGroupData()"><i class="bi bi-download"></i> 导出数据</button>
                                <select class="form-control" id="groups-per-page" style="display: inline-block; width: auto; margin-left: 10px;" onchange="changeGroupsPerPage()">
                                    <option value="10">10条/页</option>
                                    <option value="20">20条/页</option>
                                    <option value="50">50条/页</option>
                                    <option value="100">100条/页</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="groups-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortGroupTable(0)">群号 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortGroupTable(1)">群组名称 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortGroupTable(2)">态度值 <i class="bi bi-arrow-down-up"></i></th>
                                        <th>其他信息</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="groups-table-body">
                                    <!-- 群组数据将通过JavaScript动态填充 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <div class="pagination-info">显示 <span id="groups-showing-start">0</span>-<span id="groups-showing-end">0</span> 条，共 <span id="groups-total-count">0</span> 条</div>
                            <div class="pagination-controls">
                                <button class="btn btn-sm btn-primary" id="groups-prev-page" onclick="prevGroupsPage()"><i class="bi bi-chevron-left"></i> 上一页</button>
                                <span class="pagination-pages" id="groups-pagination-pages">第 <span id="groups-current-page">1</span>/<span id="groups-total-pages">1</span> 页</span>
                                <button class="btn btn-sm btn-primary" id="groups-next-page" onclick="nextGroupsPage()">下一页 <i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="response-container" id="groups-response-container" style="display:none;">
                        <div class="response-header">
                            <h3>响应结果</h3>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('groups-response-container').style.display='none';"><i class="bi bi-x"></i></button>
                        </div>
                        <div id="groups-response" class="response"></div>
                    </div>
                </div>
                
                <!-- 更新群组态度 -->
                <div class="form-group">
                    <h3>更新群组态度</h3>
                    <div class="url-display">PUT /plugins/yang208115.nekro_plugin_attitude/groups/{group_id}</div>
                    
                    <div class="form-group">
                        <label class="form-label" for="group-id">群号:</label>
                        <input type="text" class="form-control" id="group-id" placeholder="例如: 987654321">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="group-attitude">态度值:</label>
                        <input type="text" class="form-control" id="group-attitude" value="" placeholder="输入态度值 (支持数字或文字)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="group-other">群组其他信息:</label>
                        <textarea class="form-control" id="group-other" rows="3" placeholder="输入其他信息"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="updateGroup()"><i class="bi bi-save"></i> 更新群组态度</button>
                    
                    <div class="response-container" id="group-update-response-container" style="display:none;">
                        <div class="response-header">
                            <h3>响应结果</h3>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('group-update-response-container').style.display='none';"><i class="bi bi-x"></i></button>
                        </div>
                        <div id="group-update-response" class="response"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let BASE_URL = 'http://localhost:8021/plugins/yang208115.nekro_plugin_attitude';
        
        // 更新BASE_URL函数
        function updateBaseUrl() {
            const ipInput = document.getElementById('ip-input');
            const newIp = ipInput.value.trim();
            if (newIp) {
                BASE_URL = `http://${newIp}:8021/plugins/yang208115.nekro_plugin_attitude`;
                console.log('BASE_URL已更新为:', BASE_URL);
            }
        }
        
        // 检查URL参数，判断是否显示开发信息
        const urlParams = new URLSearchParams(window.location.search);
        const showDevInfo = urlParams.has('dev');
        
        // 显示响应结果
        function showResponse(elementId, data, isError = false) {
            // 如果不是开发模式，只处理数据更新，不显示响应UI
            if (!showDevInfo) {
                // 如果是获取用户或群组的响应，更新统计数据
                if (elementId === 'users-response' && !isError) {
                    updateUserStats(data.data);
                } else if (elementId === 'groups-response' && !isError) {
                    updateGroupStats(data.data);
                }
                return;
            }
            
            // 开发模式下显示完整响应
            const containerElementId = elementId + '-container';
            const containerElement = document.getElementById(containerElementId);
            const element = document.getElementById(elementId);
            
            containerElement.style.display = 'block';
            element.className = `response ${isError ? 'error' : 'success'}`;
            
            if (typeof data === 'object') {
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                element.textContent = data;
            }
            
            // 如果是获取用户或群组的响应，更新统计数据
            if (elementId === 'users-response' && !isError) {
                updateUserStats(data.data);
            } else if (elementId === 'groups-response' && !isError) {
                updateGroupStats(data.data);
            }
        }
        
        // 更新用户统计数据
        function updateUserStats(data) {
            if (!Array.isArray(data)) return;
            
            // 更新用户总数
            document.getElementById('user-count').textContent = data.length;           
            // 计算消极态度数 - 不再需要更新到页面，但保留计算逻辑以备将来使用
            let negativeCount = 0;
            
            data.forEach(user => {
                if (user.attitude) {
                    const attitudeValue = parseFloat(user.attitude);
                    if (!isNaN(attitudeValue)) {
                        if (attitudeValue < 0) {
                            negativeCount++;
                        }
                    } else if (typeof user.attitude === 'string') {
                        // 对于非数字态度值，根据关键词判断
                        const attitude = user.attitude.toLowerCase();
                        if (attitude.includes('bad') || attitude.includes('dislike') || 
                           attitude.includes('negative') || attitude.includes('angry')) {
                            negativeCount++;
                        }
                    }
                }
            });
            
            // 消极态度数卡片已被移除，不再更新
        }
        
        // 更新群组统计数据
        function updateGroupStats(data) {
            if (!Array.isArray(data)) return;
            
            // 更新群组总数
            document.getElementById('group-count').textContent = data.length;
            
            // 计算消极态度数 - 不再需要更新到页面，但保留计算逻辑以备将来使用
            let negativeCount = 0;
            
            data.forEach(group => {
                if (group.attitude) {
                    const attitudeValue = parseFloat(group.attitude);
                    if (!isNaN(attitudeValue)) {
                        if (attitudeValue < 0) {
                            negativeCount++;
                        }
                    } else if (typeof group.attitude === 'string') {
                        // 对于非数字态度值，根据关键词判断
                        const attitude = group.attitude.toLowerCase();
                        if (attitude.includes('bad') || attitude.includes('dislike') || 
                           attitude.includes('negative') || attitude.includes('angry')) {
                            negativeCount++;
                        }
                    }
                }
            });
            
            // 消极态度数卡片已被移除，不再更新
        }
        
        // 获取所有用户态度
        let allUsers = [];
        let filteredUsers = [];
        let currentUserPage = 1;
        let usersPerPage = 10;
        let userSortColumn = 0;
        let userSortDirection = 'asc';
        
        async function getAllUsers() {
            try {
                const response = await fetch(`${BASE_URL}/users`);
                const data = await response.json();
                
                if (response.ok) {
                    showResponse('users-response', {
                        status: response.status,
                        data: data
                    });
                    
                    // 保存所有用户数据
                    allUsers = data;
                    filteredUsers = [...allUsers];
                    
                    // 显示表格容器
                    document.getElementById('users-table-container').style.display = 'block';
                    
                    // 更新表格和分页
                    updateUsersTable();
                } else {
                    showResponse('users-response', {
                        status: response.status,
                        error: data
                    }, true);
                }
            } catch (error) {
                showResponse('users-response', `网络错误: ${error.message}`, true);
            }
        }
        
        // 更新用户表格
        function updateUsersTable() {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            
            // 计算当前页的数据
            const startIndex = (currentUserPage - 1) * usersPerPage;
            const endIndex = Math.min(startIndex + usersPerPage, filteredUsers.length);
            const currentPageData = filteredUsers.slice(startIndex, endIndex);
            
            // 更新显示信息
            document.getElementById('users-showing-start').textContent = filteredUsers.length > 0 ? startIndex + 1 : 0;
            document.getElementById('users-showing-end').textContent = endIndex;
            document.getElementById('users-total-count').textContent = filteredUsers.length;
            document.getElementById('users-current-page').textContent = currentUserPage;
            document.getElementById('users-total-pages').textContent = Math.ceil(filteredUsers.length / usersPerPage) || 1;
            
            // 禁用/启用分页按钮
            document.getElementById('users-prev-page').disabled = currentUserPage === 1;
            document.getElementById('users-next-page').disabled = currentUserPage >= Math.ceil(filteredUsers.length / usersPerPage);
            
            // 填充表格数据
            currentPageData.forEach(user => {
                const row = document.createElement('tr');
                
                // 用户ID列 - 显示完整QQ号
                const idCell = document.createElement('td');
                // 如果user.id是user_开头的格式，提取后面的数字部分
                let displayId = user.user_id;
                if (typeof user.user_id === 'string' && user.user_id.startsWith('user_')) {
                    displayId = user.user_id.substring(5); // 去掉'user_'前缀
                }
                idCell.textContent = displayId;
                row.appendChild(idCell);
                
                // 用户名称列
                const nameCell = document.createElement('td');
                if (user.username) {
                    nameCell.textContent = user.username;
                } else {
                    // 如果没有名称，则使用ID的一部分或其他信息作为默认名称
                    nameCell.textContent = '用户_' + (typeof user.id === 'string' ? user.id.substring(0, 5) : user.id);
                    nameCell.classList.add('text-muted');
                }
                row.appendChild(nameCell);
                
                // 态度值列
                const attitudeCell = document.createElement('td');
                if (user.attitude === null || user.attitude === undefined) {
                    attitudeCell.textContent = '无态度';
                    attitudeCell.classList.add('text-muted');
                } else {
                    attitudeCell.textContent = user.attitude;
                    if (parseFloat(user.attitude) > 0) {
                        attitudeCell.classList.add('text-success');
                    } else if (parseFloat(user.attitude) < 0) {
                        attitudeCell.classList.add('text-danger');
                    }
                }
                row.appendChild(attitudeCell);
                
                // 关系列
                const relationCell = document.createElement('td');
                if (user.relationship) {
                    relationCell.textContent = user.relationship;
                    if (user.relationship.toLowerCase() === 'friend') {
                        relationCell.classList.add('text-success');
                    } else if (user.relationship.toLowerCase() === 'enemy') {
                        relationCell.classList.add('text-danger');
                    }
                } else {
                    relationCell.textContent = '未知';
                    relationCell.classList.add('text-muted');
                }
                row.appendChild(relationCell);
                
                // 其他信息列
                const infoCell = document.createElement('td');
                const infoText = document.createElement('small');
                infoText.classList.add('text-muted');
                if (user.other) {
                    infoText.textContent = user.other;
                } else {
                    infoText.textContent = '最后更新: ' + new Date().toLocaleString();
                }
                infoCell.appendChild(infoText);
                row.appendChild(infoCell);
                
                // 操作列
                const actionCell = document.createElement('td');
                const editBtn = document.createElement('button');
                editBtn.classList.add('btn', 'btn-sm', 'btn-primary', 'mr-2');
                editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                editBtn.style.marginRight = '5px';
                editBtn.onclick = function() {
                    document.getElementById('user-id').value = user.user_id;
                    document.getElementById('user-attitude').value = user.attitude !== null ? user.attitude : '';
                    document.getElementById('user-relationship').value = user.relationship || '';
                    document.getElementById('user-other').value = user.other || '';
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.onclick = function() {
                    if (confirm('确定要删除此用户态度吗？')) {
                        deleteUser(user.user_id);
                    }
                };
                
                actionCell.appendChild(editBtn);
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 筛选用户表格
        function filterUserTable() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            
            filteredUsers = allUsers.filter(user => {
                // 搜索条件 - 匹配QQ号、用户名或关系
                const userName = user.name || ((typeof user.user_id === 'string' ? user.user_id.substring(0, 5) : user.user_id));
                const matchesSearch = (typeof user.user_id === 'string' ? user.user_id.toLowerCase().includes(searchTerm) : String(user.user_id).toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            // 重置到第一页并更新表格
            currentUserPage = 1;
            updateUsersTable();
        }
        
        // 排序用户表格
        function sortUserTable(columnIndex) {
            if (userSortColumn === columnIndex) {
                // 如果点击的是当前排序列，则切换排序方向
                userSortDirection = userSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果点击的是新列，则设置为升序
                userSortColumn = columnIndex;
                userSortDirection = 'asc';
            }
            
            filteredUsers.sort((a, b) => {
                let valueA, valueB;
                
                if (columnIndex === 0) {
                    // 按QQ号排序
                    valueA = a.id;
                    valueB = b.id;
                } else if (columnIndex === 1) {
                    // 按用户名称排序
                    valueA = a.name || ('用户_' + a.id.substring(0, 5));
                    valueB = b.name || ('用户_' + b.id.substring(0, 5));
                } else if (columnIndex === 2) {
                    // 按态度值排序，将null值视为最小
                    valueA = a.attitude === null ? -Infinity : parseFloat(a.attitude);
                    valueB = b.attitude === null ? -Infinity : parseFloat(b.attitude);
                } else if (columnIndex === 3) {
                    // 按关系排序
                    valueA = a.relationship || '';
                    valueB = b.relationship || '';
                }
                
                // 根据排序方向比较
                if (userSortDirection === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            updateUsersTable();
        }
        
        // 更改每页显示数量
        function changeUsersPerPage() {
            usersPerPage = parseInt(document.getElementById('users-per-page').value);
            currentUserPage = 1; // 重置到第一页
            updateUsersTable();
        }
        
        // 上一页
        function prevUsersPage() {
            if (currentUserPage > 1) {
                currentUserPage--;
                updateUsersTable();
            }
        }
        
        // 下一页
        function nextUsersPage() {
            if (currentUserPage < Math.ceil(filteredUsers.length / usersPerPage)) {
                currentUserPage++;
                updateUsersTable();
            }
        }
        
        // 导出用户数据
        function exportUserData() {
            // 创建JSON数据
            const jsonData = {
                version: "0.0.2",
                type: "users",
                data: filteredUsers.map(user => ({
                    id: user.id,
                    name: user.name || ('用户_' + (typeof user.id === 'string' ? user.id.substring(0, 5) : user.id)),
                    attitude: user.attitude === null ? null : user.attitude,
                    relationship: user.relationship || null,
                    other: user.other || null
                }))
            };
            
            // 将JSON对象转换为字符串
            const jsonString = JSON.stringify(jsonData, null, 2);
            
            // 创建下载链接并触发点击
            const blob = new Blob([jsonString], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "用户态度数据.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // 更新用户态度
        async function updateUser() {
            const userId = document.getElementById('user-id').value;
            const attitudeValue = document.getElementById('user-attitude').value;
            
            if (!userId) {
                showResponse('user-update-response', '请输入QQ号', true);
                return;
            }
            
            // 处理态度值，如果为空则传入 null (后端会解析为 None)
            const attitude = attitudeValue.trim() === '' ? null : attitudeValue;
            const relationship = document.getElementById('user-relationship').value;
            const other = document.getElementById('user-other').value;
            
            const requestBody = {};
            if (attitude !== null) requestBody.attitude = attitude;
            if (relationship) requestBody.relationship = relationship;
            if (other) requestBody.other = other;
            
            try {
                const response = await fetch(`${BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResponse('user-update-response', {
                        status: response.status,
                        message: '用户态度更新成功',
                        data: data
                    });
                    
                    // 更新后刷新用户列表
                    getAllUsers();
                } else {
                    showResponse('user-update-response', {
                        status: response.status,
                        error: data
                    }, true);
                }
            } catch (error) {
                showResponse('user-update-response', `网络错误: ${error.message}`, true);
            }
        }
        
        // 获取所有群组态度
        let allGroups = [];
        let filteredGroups = [];
        let currentGroupPage = 1;
        let groupsPerPage = 10;
        let groupSortColumn = 0;
        let groupSortDirection = 'asc';
        
        async function getAllGroups() {
            try {
                const response = await fetch(`${BASE_URL}/groups`);
                const data = await response.json();
                
                if (response.ok) {
                    showResponse('groups-response', {
                        status: response.status,
                        data: data
                    });
                    
                    // 保存所有群组数据
                    allGroups = data;
                    filteredGroups = [...allGroups];
                    
                    // 显示表格容器
                    document.getElementById('groups-table-container').style.display = 'block';
                    
                    // 更新表格和分页
                    updateGroupsTable();
                } else {
                    showResponse('groups-response', {
                        status: response.status,
                        error: data
                    }, true);
                }
            } catch (error) {
                showResponse('groups-response', `网络错误: ${error.message}`, true);
            }
        }
        
        // 更新群组表格
        function updateGroupsTable() {
            const tableBody = document.getElementById('groups-table-body');
            tableBody.innerHTML = '';
            
            // 计算当前页的数据
            const startIndex = (currentGroupPage - 1) * groupsPerPage;
            const endIndex = Math.min(startIndex + groupsPerPage, filteredGroups.length);
            const currentPageData = filteredGroups.slice(startIndex, endIndex);
            
            // 更新显示信息
            document.getElementById('groups-showing-start').textContent = filteredGroups.length > 0 ? startIndex + 1 : 0;
            document.getElementById('groups-showing-end').textContent = endIndex;
            document.getElementById('groups-total-count').textContent = filteredGroups.length;
            document.getElementById('groups-current-page').textContent = currentGroupPage;
            document.getElementById('groups-total-pages').textContent = Math.ceil(filteredGroups.length / groupsPerPage) || 1;
            
            // 禁用/启用分页按钮
            document.getElementById('groups-prev-page').disabled = currentGroupPage === 1;
            document.getElementById('groups-next-page').disabled = currentGroupPage >= Math.ceil(filteredGroups.length / groupsPerPage);
            
            // 填充表格数据
            currentPageData.forEach(group => {
                const row = document.createElement('tr');
                
                // 群组ID列 - 显示纯数字群号
                const idCell = document.createElement('td');
                // 如果group.id是group_开头的格式，提取后面的数字部分
                let displayId = group.group_id;
                if (typeof group.group_id === 'string' && group.group_id.startsWith('group_')) {
                    displayId = group.group_id.substring(6); // 去掉'group_'前缀
                }
                idCell.textContent = displayId;
                row.appendChild(idCell);
                
                // 群组名称列
                const nameCell = document.createElement('td');
                if (group.channel_name) {
                    nameCell.textContent = group.channel_name;
                } else {
                    // 如果没有名称，则使用ID的一部分或其他信息作为默认名称
                    nameCell.textContent = 'group_' + (typeof group.group_id === 'string' ? group.group_id.substring(0, 5) : group.group_id);
                    nameCell.classList.add('text-muted');
                }
                row.appendChild(nameCell);
                
                // 态度值列
                const attitudeCell = document.createElement('td');
                if (group.attitude === null || group.attitude === undefined) {
                    attitudeCell.textContent = '无态度';
                    attitudeCell.classList.add('text-muted');
                } else {
                    attitudeCell.textContent = group.attitude;
                    if (parseFloat(group.attitude) > 0) {
                        attitudeCell.classList.add('text-success');
                    } else if (parseFloat(group.attitude) < 0) {
                        attitudeCell.classList.add('text-danger');
                    }
                }
                row.appendChild(attitudeCell);
                
                // 其他信息列
                const infoCell = document.createElement('td');
                const infoText = document.createElement('small');
                infoText.classList.add('text-muted');
                infoText.textContent = '最后更新: ' + new Date().toLocaleString();
                infoCell.appendChild(infoText);
                row.appendChild(infoCell);
                
                // 操作列
                const actionCell = document.createElement('td');
                const editBtn = document.createElement('button');
                editBtn.classList.add('btn', 'btn-sm', 'btn-primary', 'mr-2');
                editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                editBtn.style.marginRight = '5px';
                editBtn.onclick = function() {
                    document.getElementById('group-id').value = group.group_id;
                    document.getElementById('group-attitude').value = group.attitude !== null ? group.attitude : '';
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.onclick = function() {
                    if (confirm('确定要删除此群组态度吗？')) {
                        deleteGroup(group.group_id);
                    }
                };
                
                actionCell.appendChild(editBtn);
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 筛选群组表格
        function filterGroupTable() {
            const searchTerm = document.getElementById('group-search').value.toLowerCase();
            
            filteredGroups = allGroups.filter(group => {
                // 搜索条件 - 匹配群号或群组名称
                const groupName = group.channel_name || ('group_' + (typeof group.group_id === 'string' ? group.group_id.substring(0, 5) : group.group_id));
                
                // 处理群号搜索 - 如果group_id是group_开头的格式，提取后面的数字部分进行匹配
                let searchableGroupId = group.group_id;
                if (typeof group.group_id === 'string' && group.group_id.startsWith('group_')) {
                    searchableGroupId = group.group_id.substring(6); // 去掉'group_'前缀
                }
                
                const matchesSearch = (typeof searchableGroupId === 'string' ? searchableGroupId.toLowerCase() : String(searchableGroupId).toLowerCase()).includes(searchTerm) ||
                                     (typeof groupName === 'string' ? groupName.toLowerCase() : String(groupName).toLowerCase()).includes(searchTerm);
                
                return matchesSearch;
            });
            
            // 重置到第一页并更新表格
            currentGroupPage = 1;
            updateGroupsTable();
        }
        
        // 排序群组表格
        function sortGroupTable(columnIndex) {
            if (groupSortColumn === columnIndex) {
                // 如果点击的是当前排序列，则切换排序方向
                groupSortDirection = groupSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果点击的是新列，则设置为升序
                groupSortColumn = columnIndex;
                groupSortDirection = 'asc';
            }
            
            filteredGroups.sort((a, b) => {
                let valueA, valueB;
                
                if (columnIndex === 0) {
                    // 按群号排序
                    valueA = a.group_id;
                    valueB = b.group_id;
                } else if (columnIndex === 1) {
                    // 按群组名称排序
                    valueA = a.channel_name || ('group_' + (typeof a.group_id === 'string' ? a.group_id.substring(0, 5) : a.group_id));
                    valueB = b.channel_name || ('group_' + (typeof b.group_id === 'string' ? b.group_id.substring(0, 5) : b.group_id));
                } else if (columnIndex === 2) {
                    // 按态度值排序，将null值视为最小
                    valueA = a.attitude === null ? -Infinity : parseFloat(a.attitude);
                    valueB = b.attitude === null ? -Infinity : parseFloat(b.attitude);
                }
                
                // 根据排序方向比较
                if (groupSortDirection === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            updateGroupsTable();
        }
        
        // 更改每页显示数量
        function changeGroupsPerPage() {
            groupsPerPage = parseInt(document.getElementById('groups-per-page').value);
            currentGroupPage = 1; // 重置到第一页
            updateGroupsTable();
        }
        
        // 上一页
        function prevGroupsPage() {
            if (currentGroupPage > 1) {
                currentGroupPage--;
                updateGroupsTable();
            }
        }
        
        // 下一页
        function nextGroupsPage() {
            if (currentGroupPage < Math.ceil(filteredGroups.length / groupsPerPage)) {
                currentGroupPage++;
                updateGroupsTable();
            }
        }
        
        // 导出群组数据
        function exportGroupData() {
            // 创建JSON数据
            const jsonData = {
                version: "0.0.2",
                type: "groups",
                data: filteredGroups.map(group => ({
                    id: group.group_id,
                    name: group.channel_name || ('group_' + (typeof group.group_id === 'string' ? group.group_id.substring(0, 5) : group.group_id)),
                    attitude: group.attitude === null ? null : group.attitude,
                    other: group.other || null
                }))
            };
            
            // 将JSON对象转换为字符串
            const jsonString = JSON.stringify(jsonData, null, 2);
            
            // 创建下载链接并触发点击
            const blob = new Blob([jsonString], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "群组态度数据.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // 更新群组态度
        async function updateGroup() {
            const groupId = document.getElementById('group-id').value;
            const attitudeValue = document.getElementById('group-attitude').value;
            
            if (!groupId) {
                showResponse('group-update-response', '请输入群号', true);
                return;
            }
            
            // 处理态度值，如果为空则传入 null (后端会解析为 None)
            const attitude = attitudeValue.trim() === '' ? null : attitudeValue;
            const other = document.getElementById('group-other').value;
            
            const requestBody = {};
            if (attitude !== null) requestBody.attitude = attitude;
            if (other) requestBody.other = other;
            
            try {
                const response = await fetch(`${BASE_URL}/groups/${groupId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResponse('group-update-response', {
                        status: response.status,
                        message: '群组态度更新成功',
                        data: data
                    });
                    
                    // 更新后刷新群组列表
                    getAllGroups();
                } else {
                    showResponse('group-update-response', {
                        status: response.status,
                        error: data
                    }, true);
                }
            } catch (error) {
                showResponse('group-update-response', `网络错误: ${error.message}`, true);
            }
        }
        
        // 删除用户态度
        async function deleteUser(userId) {
            if (!userId) {
                alert('QQ号不能为空');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`删除成功: ${data.message}`);
                    // 刷新用户列表
                    getAllUsers();
                } else {
                    alert(`删除失败: ${data.message || (data.detail ? data.detail : '未知错误')}`);
                }
            } catch (error) {
                alert(`删除失败: ${error.message}`);
            }
        }
        
        // 删除群组态度
        async function deleteGroup(groupId) {
            if (!groupId) {
                alert('群号不能为空');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/groups/${groupId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`删除成功: ${data.message}`);
                    // 刷新群组列表
                    getAllGroups();
                } else {
                    alert(`删除失败: ${data.message || (data.detail ? data.detail : '未知错误')}`);
                }
            } catch (error) {
                alert(`删除失败: ${error.message}`);
            }
        }
        
        // 运行所有测试
        async function runAllTests() {
            const containerElement = document.getElementById('batch-response-container');
            const element = document.getElementById('batch-response');
            
            // 只在开发模式下显示批量测试响应
            if (showDevInfo) {
                containerElement.style.display = 'block';
                element.className = 'response info';
                element.textContent = '正在运行批量测试...\n';
            }
            
            const tests = [
                { name: '获取所有用户', func: () => fetch(`${BASE_URL}/users`) },
                { name: '获取所有群组', func: () => fetch(`${BASE_URL}/groups`) },
                { name: '测试用户更新', func: () => fetch(`${BASE_URL}/users/test123`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attitude: "0.5", relationship: 'friend', other: 'test user' })
                })},
                { name: '测试群组更新', func: () => fetch(`${BASE_URL}/groups/test456`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attitude: "-0.5", other: 'test group' })
                })}
            ];
            
            let results = [];
            
            for (const test of tests) {
                try {
                    const response = await test.func();
                    const data = await response.json();
                    results.push({
                        test: test.name,
                        status: response.status,
                        success: response.ok,
                        data: data
                    });
                } catch (error) {
                    results.push({
                        test: test.name,
                        status: 'ERROR',
                        success: false,
                        error: error.message
                    });
                }
            }
            
            showResponse('batch-response', {
                message: '批量测试完成',
                results: results
            });
            
            // 刷新用户和群组列表
            getAllUsers();
            getAllGroups();
        }
        
        // 页面加载完成后自动获取数据
        window.addEventListener('load', function() {
            // 从地址栏获取主机名并设置到IP输入框
            const ipInput = document.getElementById('ip-input');
            const currentHost = window.location.hostname;
            if (currentHost && currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
                ipInput.value = currentHost;
            } else {
                // 如果是localhost或127.0.0.1，保持原来的默认值
                ipInput.value = window.location.hostname || '0.0.0.0';
            }
            // 更新BASE_URL
            updateBaseUrl();
            
            console.log('态度插件测试页面已加载');
            console.log('API基础地址:', BASE_URL);
            
            // 根据URL参数控制开发信息的显示
            if (!showDevInfo) {
                // 隐藏所有URL显示和响应结果容器
                const urlDisplays = document.querySelectorAll('.url-display');
                urlDisplays.forEach(element => {
                    element.style.display = 'none';
                });
                
                // 隐藏响应结果容器（初始状态已经是隐藏的，这里是为了确保）
                const responseContainers = document.querySelectorAll('.response-container');
                responseContainers.forEach(element => {
                    element.style.display = 'none';
                });
                
                // 隐藏批量测试按钮
                document.getElementById('batch-test-btn').style.display = 'none';
                
                // showResponse函数已经在定义时处理了开发模式的判断
            } else {
                // 在开发模式下显示批量测试按钮
                document.getElementById('batch-test-btn').style.display = 'inline-block';
            }
            
            // 加载用户和群组数据
            getAllUsers();
            getAllGroups();
            
            // 添加刷新按钮事件
            document.querySelector('.header .btn-primary').addEventListener('click', () => {
                // 重置统计数据
                document.getElementById('user-count').textContent = '0';
                document.getElementById('group-count').textContent = '0';
                // negative-count 元素已被移除，不再重置
                
                // 重新加载数据
                getAllUsers();
                getAllGroups();
            });
        });
    </script>
</body>
</html>